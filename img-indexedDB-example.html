<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8 />
  <title>ToDo List with IndexedDB</title>
  <meta name="description" content="WebSQL To IndexedDB Live Example - last updated: May 2012">
  <meta name="author" content="Ido Green">

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
  <script>
      (function () {
    // IndexedDB
    var indexedDB = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB || window.OIndexedDB || window.msIndexedDB,
        IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.OIDBTransaction || window.msIDBTransaction,
        dbVersion = 1.2;

    // Create/open database
    var request = indexedDB.open("BeerData", dbVersion),
        db,
        createObjectStore = function (dataBase) {
            // Create an objectStore
            console.log("Creating objectStore")
            dataBase.createObjectStore("beers");
        },

        getBeerData = function () {
          insertBeerToDB("GoldStar is great beer");
            // Create XHR
            // var xhr = new XMLHttpRequest(),
            //     blob;

            // xhr.open("GET", "html5-logo_250.png", true);
            // // Set the responseType to blob
            // xhr.responseType = "blob";

            // xhr.addEventListener("load", function () {
            //     if (xhr.status === 200) {
            //         console.log("Image retrieved");
                    
            //         // Blob as response
            //         blob = xhr.response;
            //         console.log("Blob:" + blob);

            //         // Put the received blob into IndexedDB
            //         insertBeerToDB(blob);
            //     }
            // }, false);
            // // Send XHR
            // xhr.send();
        },

        insertBeerToDB = function (beerData) {
            console.log("Putting beers in IndexedDB");

            // Open a transaction to the database
            var transaction = db.transaction(["beers"], "readwrite");
            // Put the beer into the dabase
            var data = {
                "value": beerData,
                "time": new Date().getTime()
              };

            var ob = transaction.objectStore("beers",{ keyPath: "curTime", autoIncrement:true });
            ob.put(data);

            // Retrieve the file that was just stored
            ob.get("beers").onsuccess = function (event) {
                var beerData = event.target.result;
                console.log("Got beers: "  + beerData);

            };
        };

    request.onerror = function (event) {
        console.log("Error creating/accessing IndexedDB database");
    };

    request.onsuccess = function (event) {
        console.log("Success creating/accessing IndexedDB database");
        db = request.result;

        db.onerror = function (event) {
            console.log("Error creating/accessing IndexedDB database");
        };
        
        // Interim solution for Google Chrome to create an objectStore. Will be deprecated
        if (db.setVersion) {
          console.log("in old setVersion: "+ db.setVersion);
            if (db.version != dbVersion) {
                var req = db.setVersion(dbVersion);
                req.onsuccess = function () {
                    //createObjectStore(db);
                    var trans = req.result;
                    trans.oncomplete = function(e) {
                      console.log("in trans oncomplete ==");
                      getBeerData();
                    }
                };
            }
            else {
                getBeerData();
            }
        }
        else {
            getBeerData();
        }
    }
    
    // For future use. Currently only in latest Firefox versions
    request.onupgradeneeded = function (event) {
        console.log("in onupgradeneeded!");
        createObjectStore(event.target.result);
    };
})();
    </script>
  <style>
      #ourList {
        background: lightcyan;
        padding: 25px;
        border-radius: 15px;
      }
      h1 {
        font-size: 130%;
      }
      h3 {
        font-size: 110%;
        margin-top: 45px;
      }
      #todo {
        background: lightgoldenrodyellow;
        width: 250px;
      }
    </style>
</head>
<body>
  <h1>ToDo list - IndexedDB Example</h1>
  <ul id="todoItems"></ul>
  <input type="text" id="todo" name="todo" placeholder="What do you need to do?" />
  <input type="submit" value="Add Todo Item" onclick="addTodo(); return false;" />

  <h3>Todos</h3>
  <input type="submit" value="Show All Todos" onclick="showAll(); return false;" />
  <div id="ourList"></div>
</body>
</html>